{% extends 'base.html' %}
{% load staticfiles %}
{% load i18n %}

{# Clear out javascript block at bottom of page so we can import specific js #}
{% block javascript %}
<script src="{% static 'js/jquery-2.2.3.min.js' %}"></script>

<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
    $.widget.bridge('uibutton', $.ui.button);
</script>

<script src="{% static 'js/bootstrap.min.js' %}"></script>

<script src="{% static 'js/app.min.js' %}"></script>

<!-- Slimscroll -->
<script src="{% static 'js/jquery.slimscroll.min.js' %}"></script>

<script src="{% static 'js/fastclick.js' %}"></script>

<script src="{% static 'js/moment.min.js' %}"></script>

<script src="{% static 'js/fullcalendar.min.js' %}"></script>

<script>
	// Fix old appointment bug step 1
    events = JSON.parse(JSON.stringify({{json_events}}));

    var current_user=JSON.parse(JSON.stringify('{{page_username}}'));
<<<<<<< HEAD
<<<<<<< HEAD
    //Copy array
    var newEvents=JSON.parse(JSON.stringify(events));
    for(var i in newEvents){
    //Editable by yourself
       newEvents[i].editable=(current_user==newEvents[i].initiator)
    }
	
	// Set up a value for Refresh feature (Refresh feature step 1).
	 var checkChange=true;
    
=======
>>>>>>> a528f8d... fix cannot delete your own event when viewing other schedule
=======
>>>>>>> 21c14de... Merge pull request #15 from Hnguyen1997/hiep-staging
    $(document).ready(function() {
    // Function triggered by submit button
    // verfies events and then calls helper function
    // postEvents to send all client side events to server.
    $('#submit-events').on('submit', function(event){
        // Prevent default behavior of submit form.
        event.preventDefault();
        // Get map of all events added on client side so far.
        var eventsOnSubmit = $('#calendar').fullCalendar('clientEvents');
		
		//For refresh feature(Refresh feature step 2)
		checkChange=false;
        
          // Prepare to send event list to server.
          postEvents(eventsOnSubmit);
    });
    
    function postEvents(cEvents) {
          $.ajax({
              url: 'ajax/save_events/',
              type: 'POST',
              data: {
                // Need to stringfy cEvents (circular structure), but must first
                // iterate through and create a simplier representation.
                jsonEvents: JSON.stringify(cEvents.map(function (e)
                {
                    return {
                        start: e.start,
                        end: e.end,
                        title: e.title,
                        initiator:e.initiator,
                    }
                }))
              },
              success: function (response) {
                // Get the response from server and process it
                // In this case simply alert the user.
                alert(response);
				
				//For Refresh feature (Refresh feature step 3)
				events=cEvents.map(function(e){
                    return {
                      start:e.start,
                        end:e.end,
                       title:e.title,
                        initiator:e.initiator
                    }
                });
                 checkChange=true;
				
                // setTimeout(function() {
                //   location.reload();  //Refresh page
                // }, 300);
              },
              error: function (xhr) {
                // Open JS debugger if ya goofed. Alert with last object.
                // This should really trigger a 500 server error.
				
				//For Refresh feature (Refresh feature step 4)
				checkChange=true;
				
                debugger;
                alert(xhr);
            }
          });
      }

    $('#calendar').fullCalendar({

          // Only show agendaWeek view for edit_schedule
          defaultView: 'month',
          fixedWeekCount: false,
          showNonCurrentDates: true,
<<<<<<< HEAD

          // HEADER
          header: {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
            left: 'month,agendaWeek,agendaDay',
            center: 'title',
            right: 'prev,today,next'
=======
            left: 'agendaDay,agendaWeek,month',
            center: 'title',
            right: 'today prev,next'
<<<<<<< HEAD
>>>>>>> 0d695d6... Change weekly calendar view to monthly.
=======

>>>>>>> 3dc331d... Merge branch 'master' into Nikki
=======
=======
>>>>>>> 9f4e50f... Merge branch 'master' into Anisha
=======

>>>>>>> 662aaeb... Merge pull request #5 from Hnguyen1997/hiep-testing
=======

>>>>>>> 92109ae... Merge pull request #8 from Hnguyen1997/hiep-new
            left: 'agendaDay,agendaWeek,month',
=======
            left: 'today prev,next',
>>>>>>> c82aaa0... Merge pull request #10 from Hnguyen1997/anisha
            center: 'title',
            right: 'agendaDay,agendaWeek,month'
          },

<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> 7e7f500... Merge pull request #2 from Hnguyen1997/Nikki
=======
>>>>>>> 9f4e50f... Merge branch 'master' into Anisha
=======
            left: 'agendaDay,agendaWeek,month',
=======
            left: 'today prev,next',
>>>>>>> 7e0a120... Changes to calendar UI.
            center: 'title',
            right: 'agendaDay,agendaWeek,month'
          },

<<<<<<< HEAD
>>>>>>> 58eb5bf... light/dark theme fix test 2(don't merge)
          },
          // Day of week shouldn't contain hard coded date.
<<<<<<< HEAD
<<<<<<< HEAD
          columnFormat: 'dddd',
=======
            left: 'month,agendaWeek,agendaDay',
=======

            left: 'agendaDay,agendaWeek,month',
>>>>>>> 7832d2a... Merge branch 'hiep-new' into hiep-testing
=======

          // HEADER
          header: {
            left: 'today prev,next',
>>>>>>> 5223c9d... Merge branch 'master' into hiep-staging
            center: 'title',
            right: 'agendaDay,agendaWeek,month'
          },

          customButtons: {
            addEventBtn: {
              text: 'add event',
              click: function(){
                alert('button clicked!');
              }
            }
          },

          // COLUMN HEADER DATE FORMATS
          views: {
            month: {
              titleFormat: 'MMMM YYYY',
              columnFormat: 'dddd'
            },
            agenda: {
              columnFormat: 'ddd M/D'
            }
          },

          // Day of week shouldn't contain hard coded date.
<<<<<<< HEAD
          columnFormat: 'dddd M/D',
<<<<<<< HEAD
>>>>>>> 04fdb38... all day & multi-day event show up (fix strange submit bug after import)
=======

>>>>>>> 7832d2a... Merge branch 'hiep-new' into hiep-testing
=======
          columnFormat: 'dddd M/D',

>>>>>>> 662aaeb... Merge pull request #5 from Hnguyen1997/hiep-testing
=======
          columnFormat: 'dddd M/D',

>>>>>>> 92109ae... Merge pull request #8 from Hnguyen1997/hiep-new
=======
          // COLUMN HEADER DATE FORMATS
          views: {
            month: {
              titleFormat: 'MMMM YYYY',
              columnFormat: 'dddd'
            },
            agenda: {
              columnFormat: 'ddd M/D'
            }
          },
=======
            left: 'today prev,next',
=======
            left: 'agendaDay,agendaWeek,month',
>>>>>>> fcf33f9... trying to see if my pushes are working
            center: 'title',
            right: 'today prev,next'
          },

          // COLUMN HEADER DATE FORMATS
          views: {
            month: {
              titleFormat: 'MMMM YYYY',
              columnFormat: 'dddd'
            },
            agenda: {
              columnFormat: 'ddd M/D'
            }
          },
>>>>>>> b21ccf8... Merge pull request #9 from Hnguyen1997/nikki-2
=======
          // COLUMN HEADER DATE FORMATS
          views: {
            month: {
              titleFormat: 'MMMM YYYY',
              columnFormat: 'dddd'
            },
            agenda: {
              columnFormat: 'ddd M/D'
            }
          },
>>>>>>> c82aaa0... Merge pull request #10 from Hnguyen1997/anisha
=======
            left: 'today prev,next',
=======
            left: 'today prev,next addEventBtn',
>>>>>>> 6e8f08d... hopefully button to add events in monthly view
=======
            left: 'today prev,next',
>>>>>>> cf3500e... ...
            center: 'title',
            right: 'agendaDay,agendaWeek,month'
          },

          customButtons: {
            addEventBtn: {
              text: 'add event',
              click: function(){
                alert('button clicked!');
              }
            }
          },

          // COLUMN HEADER DATE FORMATS
          views: {
            month: {
              titleFormat: 'MMMM YYYY',
              columnFormat: 'dddd'
            },
            agenda: {
              columnFormat: 'ddd M/D'
            }
          },
>>>>>>> e63de6a... refresh feature upload and bug fix 1
=======

>>>>>>> 5223c9d... Merge branch 'master' into hiep-staging

          // Day of week shouldn't contain hard coded date.


          // FOOTER
          // automatically set to default: false
          
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> 7e0a120... Changes to calendar UI.
=======
>>>>>>> b21ccf8... Merge pull request #9 from Hnguyen1997/nikki-2
=======
>>>>>>> c82aaa0... Merge pull request #10 from Hnguyen1997/anisha
=======
>>>>>>> e63de6a... refresh feature upload and bug fix 1
=======
          
>>>>>>> 8c5ba83... some more changes
=======
          
>>>>>>> 7878f90... Merge pull request #12 from Hnguyen1997/nikki-2
=======
          
>>>>>>> 5223c9d... Merge branch 'master' into hiep-staging
          businessHours: {
              // days of week. an array of zero-based day of week integers (0=Sunday)
              dow: [ 1, 2, 3, 4, 5], // Monday - Friday

              start: '8:00', // a start time (10am in this example)
              end: '22:00', // an end time (6pm in this example)
          },
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
          defaultView: 'month',
=======
>>>>>>> 7e7f500... Merge pull request #2 from Hnguyen1997/Nikki

=======
          
>>>>>>> 0d695d6... Change weekly calendar view to monthly.
=======
=======
>>>>>>> 7832d2a... Merge branch 'hiep-new' into hiep-testing

>>>>>>> 3dc331d... Merge branch 'master' into Nikki
=======
=======
>>>>>>> 58eb5bf... light/dark theme fix test 2(don't merge)

<<<<<<< HEAD
>>>>>>> 9f4e50f... Merge branch 'master' into Anisha
=======
>>>>>>> 04fdb38... all day & multi-day event show up (fix strange submit bug after import)
          // slotDuration:'00:15:00',         //change event duration
          // Can click day/week names to navigate views
          navLinks: true,
          //now indicator
          nowIndicator: true,
          // Here Sean -andgates
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> ce379ee... Merge pull request #13 from Hnguyen1997/hiep-staging
          allDaySlot: true,

=======
          allDaySlot: false,
>>>>>>> fcf33f9... trying to see if my pushes are working
          // Allow users to resize events.
          editable: false,
          // Allow "more" link when too many events.
          eventLimit: true,
		  // Fix old appointment bug step 2
          events:newEvents,
          eventOverlap:false,

           //Limit the user to set the appointment 
          selectOverlap: function(event){
            return event.rendering === 'background';
          },
          
          // Allow selection for select function.
          selectable: true,
          selectHelper: true,
          selectConstraint:{
            start: '00:01', 
            end: '23:59', 
          },

           //Limit the user to set the appointment 
          selectOverlap: function(event){
            return event.rendering === 'background';
          },
          
          //Double click on event to delete
          eventRender: function(event, element) {
            element.on('dblclick',event, function() {
       
              if(event.title !== 'Busy' && event.initiator == current_user){
                event_start=moment(event.start).format('MMMM Do YYYY, h:mm:ss a')
                event_end=moment(event.end).format('MMMM Do YYYY, h:mm:ss a ')
                $('#eventModal').modal('show');
                $('#eventModal').modal('handleUpdate');
                $('#eventModalTitle').html(event.title);
                $('#eventModalStart').html(event_start);
                $('#eventModalEnd').html(event_end);
                $('#eventDelete').click(event,function(){
                  $('#calendar').fullCalendar('removeEvents', event._id);
                });
              }else{
                $('#noteventModal').modal('show');
                $('#noteventModalTitle').html(event.title)
                
              }    
            });
            var ending = event.end ? "\nEnd: " + event.end.format('LT') : ""
            if(event.initiator != current_user){
              element.popover({
                animation:true,
                delay: 300,
                content: "NOT YOUR" + "\n" + event.title + "\n" + "Start: " + event.start.format('LT') + ending, 
                trigger: 'hover'
              });
            }else{
              element.popover({
                animation:true,
                delay: 300,
                content: event.title + "\n" + "Start: " + event.start.format('LT') + "\n" + ending, 
                trigger: 'hover'
              });
            }
          },
          // Function called on select event.
          // Adapted from https://fullcalendar.io/js/fullcalendar-3.4.0/demos/selectable.html
          select: function(start, end) {
            // Title is always Busy in edit_schedule
            
            var title = 'Appointment';
            // Event Object to be passed to renderEvent
            var eventData;
            
            // Always true (likely change this to a check for "all day")
            if (title) {
              // Populate the Event Object. TODO: Add attributes.
              eventData = {
                title: title,
                start: start,
                end: end,
                color:'#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6),  //add random_color to calendar
                editable:true,
                initiator:current_user
              };
              // Render the event object with 'stick' set to true
              // so events persist unless page refresh.
              
              $('#calendar').fullCalendar('renderEvent', eventData, true);

            }
            
            // Unselct event area before exiting select method.
            $('#calendar').fullCalendar('unselect');
          },

      })
	  
	  // Main code of the Refresh feature (For refresh feature step 5)
	  var confirmTag=false;

      setInterval(function(){
      	$.ajax({
              url: 'ajax/refresh_schedule/',
              type: 'POST',
              success: function (response) {
                var resp=response.split(" ").join("");
              	if(JSON.stringify(events)!=resp&&checkChange){
              	    events=JSON.parse(resp);
              		if(!confirmTag){
              			confirmTag=true;
              			var sure=confirm("New schedule is detected. Do you need refresh this schedule?");
              			if(sure){
              				window.location.reload();
              			}
              			confirmTag=false;
              		}

              	}
              }
          });
		  // Refresh Check time
      },1000)
	  
     }) // End fullCalendar initialization.
     

</script>
{% endblock javascript %}
{% block stylesheets %}

  {{ block.super }}

  <!-- fullCalendar 2.2.5-->
  <link rel="stylesheet" href="{% static 'css/fullcalendar.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/fullcalendar.print.css' %}" media="print">

{% endblock stylesheets %}

{# Add the breadcrumbs for this page #}
{% block crumb %}

{# Breadcrumb for the course that this project is in #}
<li><a href="{% url 'profile' page_username %}"> {{page_username}} </a></li>
{% endblock crumb %}

{% block content %}

<section class="content">
          
              <div class="row">
                  <div class="box box-primary">
                    <div class="box-body no-padding">
                      <!-- THE CALENDAR -->
                      <div id="calendar">
        
                      </div>
                      <!-- /.calendar -->
                    </div>
                    <!-- /.box-body -->
                  </div>
                  <!-- /. box -->
          
              </div>
              <div class="pull-right">
                  <form method="POST" id="submit-events">
                    {% csrf_token %}
                    <input type="submit" name "submit" value="Update Appointments">
                  </form>
                </div>

              <!-- /.row -->
              <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalEdit" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="eventModalTitle"></h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <h2 id="eventModalStart"></h2>
                      <span>To</span>
                      <h2 id="eventModalEnd"></h2>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-danger" data-dismiss="modal" id="eventDelete">Delete Event</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="modal fade" id="noteventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="noteventModalTitle"></h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <h3>Not Your Appointment</h3>            
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
        </section>
        
{% endblock content %}